<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>AI Chat ‚Äì iOS Mobile</title>
<style>
  :root{
    --glass-bg: rgba(255,255,255,0.95);
    --glass-ring: rgba(0,0,0,.08);
    --text: #111;
    --text-dim: #999;
    --bubble-user: #007AFF;
    --bubble-assistant: #E5E5EA;
    --bg: #ffffff;
    --danger: #ff3b30;
    --success:#34C759;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;background:var(--bg)}
  body{
    font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    color:var(--text);
  }
  /* ===== Mobile Shell (single column) ===== */
  .app{display:flex;flex-direction:column;height:100dvh;max-width:540px;margin:0 auto;background:var(--bg)}
  .safe-top{height: env(safe-area-inset-top)}
  .safe-bottom{height: env(safe-area-inset-bottom)}
  /* Top App Bar */
  .topbar{ position:sticky;top:0;z-index:5; display:flex;align-items:center;justify-content:space-between;gap:8px; padding:10px 12px calc(10px + env(safe-area-inset-top)) 12px; background:var(--glass-bg);backdrop-filter: blur(16px) saturate(150%); border-bottom:1px solid var(--glass-ring); }
  .title{font-weight:700;font-size:16px;}
  .chip{height:28px;padding:0 10px;border-radius:999px;background:#fff;border:1px solid var(--glass-ring);display:flex;align-items:center;gap:6px;font-size:12px}
  .iconbtn{border:1px solid var(--glass-ring);background:#fff;border-radius:12px;padding:8px;display:flex;align-items:center;justify-content:center;min-width:36px}

  /* Messages */
  .scroller{flex:1;overflow:auto;padding:12px;position:relative}
  .empty-state{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:var(--text-dim);font-size:15px;opacity:0.6;width:80%;pointer-events:none}
  .row{display:flex;width:100%;margin-bottom:12px;animation:fade .2s}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .bubble{max-width:86%;border-radius:18px;padding:12px 14px;line-height:1.55;font-size:15px;white-space:pre-wrap;word-wrap:break-word}
  .user{justify-content:flex-end}
  .assistant{justify-content:flex-start}
  .bubble.user{background:var(--bubble-user);color:#fff}
  .bubble.assistant{background:var(--bubble-assistant);color:#111}
  
  /* Code blocks */
  .bubble pre{
    background:#f8f9fa;
    color:#333;
    border-radius:10px;
    padding:12px;
    overflow-x:auto;
    margin:8px 0;
    position:relative;
    border:1px solid #e9ecef;
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    font-size:13px;
    line-height:1.5;
  }
  .bubble pre code{
    background:transparent;
    padding:0;
    border-radius:0;
    color:inherit;
    display:block;
  }
  .code-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:6px 10px;
    background:#e9ecef;
    border-radius:8px 8px 0 0;
    margin:-12px -12px 8px -12px;
    font-size:11px;
    color:#666;
    font-weight:600;
  }
  .copy-btn{
    border:none;
    background:#007AFF;
    color:#fff;
    border-radius:6px;
    padding:4px 10px;
    font-size:11px;
    cursor:pointer;
    font-weight:600;
  }
  .copy-btn:active{background:#0051D5}
  
  .bubble code{
    background:rgba(0,0,0,.08);
    padding:2px 6px;
    border-radius:4px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    font-size:13px;
    color:#d73a49;
  }
  .file-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#fff;border:1px solid var(--glass-ring);font-size:12px;margin-top:6px}

  /* Image preview in messages */
  .image-attachment{max-width:200px;border-radius:12px;margin-top:8px;border:1px solid var(--glass-ring)}

  /* Thinking card */
  .thinking{position:sticky;bottom:76px;z-index:2;margin:0 12px 6px 12px;padding:10px;background:var(--glass-bg);backdrop-filter: blur(16px);border:1px solid var(--glass-ring);border-radius:14px;display:none;opacity:0;transform:translateY(10px);transition:opacity 0.3s, transform 0.3s}
  .thinking.show{opacity:1;transform:translateY(0)}
  .thinking.fade-out{opacity:0;transform:translateY(-10px)}
  .think-head{display:flex;align-items:center;justify-content:space-between}
  .spinner{width:14px;height:14px;border-radius:50%;border:2px solid #007AFF;border-top-color:transparent;animation:spin .8s linear infinite;display:inline-block}
  @keyframes spin{to{transform:rotate(360deg)}}
  .dots{display:grid;gap:6px;margin-top:8px}
  .dot{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-dim)}
  .dot i{width:8px;height:8px;border-radius:50%;background:#bbb}
  .dot.active i{background:#007AFF}
  .dot.done i{background:var(--success)}

  /* Composer pinned at bottom */
  .composer{ position:sticky;bottom:0;z-index:3; padding:8px 8px calc(8px + env(safe-area-inset-bottom)); background:linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 18%); }
  .card{background:var(--glass-bg);backdrop-filter: blur(16px);border:1px solid var(--glass-ring);border-radius:16px;padding:8px}
  .rowwrap{display:flex;align-items:flex-end;gap:8px}
  textarea{flex:1;min-height:42px;max-height:140px;resize:none;border:1px solid var(--glass-ring);border-radius:12px;padding:10px 12px;background:#fff;font-size:15px;outline:none}
  .send{background:#007AFF;color:#fff;border:none;border-radius:12px;padding:12px 14px;font-weight:700;min-width:64px}
  .toolbtn{border:1px solid var(--glass-ring);background:#fff;border-radius:12px;padding:10px;min-width:42px}
  .attach-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}

  /* Bottom Tabbar (actions) */
  .tabbar{position:fixed;left:0;right:0;bottom:0;z-index:2;display:flex;justify-content:space-around;gap:8px;max-width:540px;margin:0 auto;padding:8px 10px calc(8px + env(safe-area-inset-bottom));background:var(--glass-bg);backdrop-filter:blur(14px);border-top:1px solid var(--glass-ring)}
  .tabbar .tbtn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;border:none;background:transparent;font-size:12px;color:#222}

  /* Sheets */
  .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.3);backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:.2s;z-index:9}
  .sheet{position:fixed;left:0;right:0;bottom:0;z-index:10;transform:translateY(100%);transition:.25s}
  .sheet.open{transform:none}
  .sheet-backdrop.open{opacity:1;pointer-events:auto}
  .sheet .panel{max-width:540px;margin:0 auto;border-top-left-radius:16px;border-top-right-radius:16px;background:var(--glass-bg);backdrop-filter:blur(16px);border:1px solid var(--glass-ring);padding:12px}
  .form{display:grid;gap:10px}
  .label{font-size:12px;color:var(--text-dim);font-weight:700}
  .input,.select,.textarea{border:1px solid var(--glass-ring);border-radius:12px;padding:10px 12px;background:#fff;font-size:15px}
  .row-between{display:flex;align-items:center;justify-content:space-between}
  .btn{border:1px solid var(--glass-ring);background:#fff;border-radius:12px;padding:10px 12px}
  .btn.primary{background:#007AFF;color:#fff;border-color:transparent}
  .btn.danger{background:var(--danger);color:#fff;border-color:transparent}

  /* Three dots animation for AI messages */
  .typing-dots{display:inline-flex;align-items:center;height:20px}
  .typing-dots span{display:inline-block;width:4px;height:4px;border-radius:50%;background:#666;margin:0 1px;animation:typing 1.4s infinite ease-in-out}
  .typing-dots span:nth-child(1){animation-delay:-0.32s}
  .typing-dots span:nth-child(2){animation-delay:-0.16s}
  @keyframes typing{
    0%, 80%, 100%{transform:scale(0.8);opacity:0.5}
    40%{transform:scale(1);opacity:1}
  }

  .hidden{display:none!important}
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css " crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js " crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js " crossorigin="anonymous"></script>
</head>
<body>
<div class="app">
  <div class="topbar">
    <button id="btnMenu" class="iconbtn" aria-label="H·ªôi tho·∫°i">‚ò∞</button>
    <div class="title">D∆∞∆°ng Api</div>
    <div id="modelChip" class="chip">Sonnet 4.5</div>
  </div>
  <div id="thinkCard" class="thinking">
    <div class="think-head">
      <div style="display:flex;align-items:center;gap:8px">
        <span class="spinner"></span>
        <strong>ƒêang suy nghƒ©‚Ä¶</strong>
      </div>
      <button id="btnToggleThink" class="btn">Thu g·ªçn</button>
    </div>
    <div id="thinkBody">
      <div id="dots" class="dots"></div>
    </div>
  </div>
  <div id="scroller" class="scroller" aria-live="polite">
    <div class="empty-state">H√£y g·ª≠i tin nh·∫Øn ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒëo·∫°n chat</div>
  </div>
  <div class="composer">
    <div class="card">
      <form id="form" class="rowwrap">
        <button id="btnAttach" class="toolbtn" type="button" title="ƒê√≠nh k√®m">üìé</button>
        <textarea id="text" placeholder="Nh·∫≠p tin nh·∫Øn‚Ä¶" rows="1"></textarea>
        <button id="send" class="send" type="submit">G·ª≠i</button>
      </form>
      <div id="attachList" class="attach-list"></div>
    </div>
  </div>
  <div class="tabbar">
    <button id="btnMic" class="tbtn" type="button">üé§<span>Gi·ªçng n√≥i</span></button>
    <button id="btnSpeak" class="tbtn" type="button">üîà<span>ƒê·ªçc</span></button>
    <button id="btnNewChat" class="tbtn" type="button">‚ûï<span>Chat m·ªõi</span></button>
  </div>
</div>

<!-- Drawer: Chat list with Settings -->
<div id="backdropList" class="sheet-backdrop"></div>
<div id="sheetList" class="sheet">
  <div class="panel">
    <div class="row-between" style="margin-bottom:6px">
      <div style="font-weight:700">H·ªôi tho·∫°i</div>
      <div>
        <button id="btnSettingsInList" class="btn" style="margin-right:8px">‚öôÔ∏è</button>
        <button id="closeList" class="btn">‚úñ</button>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px">
      <button id="btnNewChatInList" class="btn primary" style="flex:1">+ T·∫°o ƒëo·∫°n chat m·ªõi</button>
      <button id="btnClearHistory" class="btn danger" title="X√≥a to√†n b·ªô l·ªãch s·ª≠">üóëÔ∏è</button>
    </div>
    <div id="chatList" style="display:grid;gap:6px;max-height:50dvh;overflow:auto"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="btnExportMd" class="btn" style="flex:1">‚¨áÔ∏è Markdown</button>
      <button id="btnExportJson" class="btn" style="flex:1">‚¨áÔ∏è JSON</button>
    </div>
  </div>
</div>

<!-- Bottom sheet: Settings -->
<div id="backdrop" class="sheet-backdrop"></div>
<div id="sheet" class="sheet">
  <div class="panel">
    <div class="row-between" style="margin-bottom:6px"><div style="font-weight:700">C√†i ƒë·∫∑t</div><button id="closeSheet" class="btn">‚úñ</button></div>
    <div class="form">
      <label class="label">Model (T·ª´ r·∫ª ƒë·∫øn ƒë·∫Øt)
        <select id="inpModel" class="select">
          <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku üí∞</option>
          <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet üí∞üí∞</option>
          <option value="claude-sonnet-4-20250514">Claude Sonnet 4 üí∞üí∞üí∞</option>
          <option value="claude-sonnet-4-5-20250929">Claude Sonnet 4.5 üí∞üí∞üí∞üí∞</option>
          <option value="claude-opus-4-20250514">Claude Opus 4 üí∞üí∞üí∞üí∞üí∞</option>
          <option value="claude-opus-4-1-20250805">Claude Opus 4.1 Pro üí∞üí∞üí∞üí∞üí∞üí∞</option>
        </select>
      </label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <label class="label">Temperature
          <input id="inpTemp" class="input" type="number" min="0" max="1.5" step="0.1" value="0.7"/>
        </label>
        <label class="label">Max tokens
          <input id="inpMaxTok" class="input" type="number" min="256" max="8192" value="4096"/>
        </label>
      </div>
      <label class="label">System prompt
        <textarea id="inpSystem" class="textarea" rows="3" placeholder="B·∫°n l√† tr·ª£ l√Ω h·ªØu √≠ch‚Ä¶"></textarea>
      </label>
      <div style="display:flex;gap:8px">
        <button id="btnSaveCfg" class="btn primary" style="flex:1">L∆∞u</button>
        <button id="btnClearChat" class="btn" style="flex:1;color:#d00;border-color:#ffd4d1">X√≥a chat hi·ªán t·∫°i</button>
      </div>
    </div>
  </div>
</div>

<input id="file" type="file" accept="image/*,.txt,.md,.json,.pdf" hidden />

<script>
// ===== C·∫§U H√åNH API - S·ª¨A ·ªû ƒê√ÇY =====
const DEFAULT_API_KEY = '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';
// =====================================

(function(){
  "use strict";
  
  const $ = (q)=>document.querySelector(q);
  const scroller = $('#scroller');
  const text = $('#text');
  const sendBtn = $('#send');
  const think = $('#thinkCard');
  const dots = $('#dots');
  const btnToggleThink = $('#btnToggleThink');
  const modelChip = $('#modelChip');
  const emptyState = scroller.querySelector('.empty-state');

  const CFG = {
    // key: localStorage.getItem('anthropicKey') || DEFAULT_API_KEY,
    key: DEFAULT_API_KEY,
    model: localStorage.getItem('claudeModel') || 'claude-sonnet-4-5-20250929',
    temp: Number(localStorage.getItem('temp') || '0.7'),
    max_tokens: Number(localStorage.getItem('maxTokens') || '4096'),
    system: localStorage.getItem('system') || ''
  };
  
  function saveCfg(){
    // Kh√¥ng l∆∞u API Key n·ªØa
    // localStorage.setItem('anthropicKey', CFG.key);
    localStorage.setItem('claudeModel', CFG.model);
    localStorage.setItem('temp', String(CFG.temp));
    localStorage.setItem('maxTokens', String(CFG.max_tokens));
    localStorage.setItem('system', CFG.system);
  }

  let CURRENT = null;
  const store = {
    list: ()=> JSON.parse(localStorage.getItem('aiChats')||'[]'),
    save: (arr)=> localStorage.setItem('aiChats', JSON.stringify(arr)),
    upsert: (chat)=>{const arr=store.list();const i=arr.findIndex(c=>c.id===chat.id);if(i>=0)arr[i]=chat;else arr.unshift(chat);store.save(arr);},
    get: id=> store.list().find(c=>c.id===id),
    remove: id=> store.save(store.list().filter(c=>c.id!==id)),
    clear: ()=> {localStorage.removeItem('aiChats');}
  };
  
  function uid(){return 'c_'+Math.random().toString(36).slice(2)}

  function newChat(seed){
    CURRENT = {id:uid(),title:'Cu·ªôc tr√≤ chuy·ªán m·ªõi',model:CFG.model,created:Date.now(),msgs: seed?[seed]:[]};
    store.upsert(CURRENT);
    renderList();
    scroller.innerHTML = '<div class="empty-state">H√£y g·ª≠i tin nh·∫Øn ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒëo·∫°n chat</div>';
  }
  
  function loadChat(id){
    const c = store.get(id);
    if(!c) return;
    CURRENT=c;
    scroller.innerHTML='<div class="empty-state">H√£y g·ª≠i tin nh·∫Øn ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒëo·∫°n chat</div>';
    c.msgs.forEach(m=>{
      const b=addMsg(m.role,m.content,m.attachments);
      if(m.role==='assistant') renderMath(b);
    });
    renderList();
  }
  
  function saveCurrent(){if(CURRENT) store.upsert(CURRENT)}

  const sheetList = $('#sheetList');
  const backdropList = $('#backdropList');
  const chatList = $('#chatList');
  
  $('#btnMenu').onclick = ()=>{backdropList.classList.add('open');sheetList.classList.add('open');renderList();};
  $('#closeList').onclick = ()=>{backdropList.classList.remove('open');sheetList.classList.remove('open');};
  backdropList.onclick = $('#closeList').onclick;

  $('#btnNewChatInList').onclick = ()=>{
    newChat();
    backdropList.classList.remove('open');
    sheetList.classList.remove('open');
  };

  $('#btnClearHistory').onclick = ()=>{
    if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ tr√≤ chuy·ªán?')) {
      store.clear();
      newChat();
      backdropList.classList.remove('open');
      sheetList.classList.remove('open');
    }
  };

  $('#btnSettingsInList').onclick = ()=>{
    backdropList.classList.remove('open');
    sheetList.classList.remove('open');
    openSettings();
  };

  function renderList(){
    chatList.innerHTML='';
    const arr = store.list();
    arr.forEach(c=>{
      const item = document.createElement('div');
      item.style.display = 'flex';
      item.style.alignItems = 'center';
      item.style.gap = '8px';
      
      const chatBtn = document.createElement('button');
      chatBtn.className='btn';
      chatBtn.style.textAlign='left';
      chatBtn.style.flex = '1';
      chatBtn.style.display='flex';
      chatBtn.style.justifyContent='space-between';
      chatBtn.style.alignItems='center';
      chatBtn.innerHTML = `<span style="font-weight:600;max-width:70%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.title}</span><span style="opacity:.6">${new Date(c.created).toLocaleDateString()}</span>`;
      chatBtn.onclick = ()=>{loadChat(c.id); backdropList.classList.remove('open'); sheetList.classList.remove('open');};
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn';
      deleteBtn.innerHTML = 'üóëÔ∏è';
      deleteBtn.style.flexShrink = '0';
      deleteBtn.title = 'X√≥a cu·ªôc tr√≤ chuy·ªán n√†y';
      deleteBtn.onclick = (e)=>{
        e.stopPropagation();
        if(confirm(`X√≥a cu·ªôc tr√≤ chuy·ªán "${c.title}"?`)) {
          store.remove(c.id);
          if(CURRENT && CURRENT.id === c.id) {
            const list = store.list();
            if(list.length > 0) {
              loadChat(list[0].id);
            } else {
              newChat();
            }
          }
          renderList();
        }
      };
      
      item.appendChild(chatBtn);
      item.appendChild(deleteBtn);
      chatList.appendChild(item);
    });
  }
  
  function download(filename, text) {
    const element = document.createElement('a');
    element.setAttribute('href', 'text/plain;charset=utf-8,' + encodeURIComponent(text));
    element.setAttribute('download', filename);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
  }
  
  $('#btnExportJson').onclick = ()=>{download('chats.json', JSON.stringify(store.list(),null,2));};
  $('#btnExportMd').onclick = ()=>{
    if(!CURRENT) return;
    const lines=[`# ${CURRENT.title}\n`];
    CURRENT.msgs.forEach(m=>{lines.push(m.role==='user'?'## üë§ User':'## ü§ñ Assistant','',m.content||'','');});
    download((CURRENT.title||'chat')+'.md', lines.join('\n'));
  };

  const sheet = $('#sheet');
  const backdrop = $('#backdrop');
  
  function getModelName(modelValue) {
    const names = {
      'claude-3-5-haiku-20241022': 'Haiku 3.5',
      'claude-3-5-sonnet-20241022': 'Sonnet 3.5',
      'claude-sonnet-4-20250514': 'Sonnet 4',
      'claude-sonnet-4-5-20250929': 'Sonnet 4.5',
      'claude-opus-4-20250514': 'Opus 4',
      'claude-opus-4-1-20250805': 'Opus 4.1'
    };
    return names[modelValue] || 'Claude';
  }
  
  function openSettings(){
    // $('#inpKey').value = CFG.key; // Kh√¥ng c·∫ßn hi·ªÉn th·ªã API Key n·ªØa
    $('#inpModel').value=CFG.model;
    $('#inpTemp').value=CFG.temp;
    $('#inpMaxTok').value=CFG.max_tokens;
    $('#inpSystem').value=CFG.system;
    backdrop.classList.add('open');
    sheet.classList.add('open');
  }
  
  $('#closeSheet').onclick = ()=>{backdrop.classList.remove('open');sheet.classList.remove('open');};
  backdrop.onclick = $('#closeSheet').onclick;
  
  $('#btnSaveCfg').onclick = ()=>{
    // CFG.key = $('#inpKey').value.trim(); // Kh√¥ng c·∫≠p nh·∫≠t API Key n·ªØa
    CFG.model=$('#inpModel').value;
    CFG.temp=Number($('#inpTemp').value)||0.7;
    CFG.max_tokens=Number($('#inpMaxTok').value)||4096;
    CFG.system=$('#inpSystem').value;
    saveCfg();
    modelChip.textContent = getModelName(CFG.model);
    backdrop.classList.remove('open');
    sheet.classList.remove('open');
    addMsg('assistant','‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t.');
  };
  
  $('#btnClearChat').onclick = ()=>{
    if(!CURRENT) return;
    if(confirm('X√≥a h·ªôi tho·∫°i hi·ªán t·∫°i?')){
      store.remove(CURRENT.id);
      const rest=store.list();
      if(rest[0]) loadChat(rest[0].id);
      else newChat();
    }
  };

  // ===== H·ªÜ TH·ªêNG CU·ªòN TH√îNG MINH =====
  let isGenerating = false;
  let userScrolled = false;
  let scrollTimeout = null;

  function isNearBottom() {
    const threshold = 150;
    return scroller.scrollHeight - scroller.scrollTop - scroller.clientHeight < threshold;
  }

  function scrollToBottom(){
    if (!userScrolled || isNearBottom()) {
      requestAnimationFrame(()=>{
        scroller.scrollTop = scroller.scrollHeight;
      });
    }
  }

  // Theo d√µi khi user cu·ªôn
  scroller.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    
    if (isGenerating) {
      // Ki·ªÉm tra xem user c√≥ cu·ªôn l√™n kh√¥ng
      const isAtBottom = isNearBottom();
      
      if (isAtBottom) {
        userScrolled = false; // User ƒë√£ cu·ªôn v·ªÅ cu·ªëi, ti·∫øp t·ª•c auto-scroll
      } else {
        userScrolled = true; // User ƒëang xem tin nh·∫Øn ·ªü tr√™n
      }
    }
    
    // Reset userScrolled sau 1 gi√¢y kh√¥ng cu·ªôn
    scrollTimeout = setTimeout(() => {
      if (isGenerating && isNearBottom()) {
        userScrolled = false;
      }
    }, 1000);
  });

  function md(content){
    if(!content) return '';
    let html = content
      .replace(/&/g,'&amp;')
      .replace(/</g,'<')
      .replace(/>/g,'>');
    
    // Code blocks v·ªõi language detection
    html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
      const language = lang || 'text';
      const escapedCode = code.trim();
      const encoded = encodeURIComponent(escapedCode);
      return `<pre><code class="language-${language}"><div class="code-header"><span>${language.toUpperCase()}</span><button class="copy-btn" data-copy="${encoded}">Copy</button></div>${escapedCode}</code></pre>`;
    });
    
    // Inline code
    html = html.replace(/`([^`]+?)`/g,'<code>$1</code>');
    
    // Bold & italic
    html = html.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
    html = html.replace(/\*(.+?)\*/g,'<em>$1</em>');
    
    // Headers
    html = html.replace(/^### (.+)$/gm,'<h4>$1</h4>');
    html = html.replace(/^## (.+)$/gm,'<h3>$1</h3>');
    html = html.replace(/^# (.+)$/gm,'<h2>$1</h2>');
    
    // Links
    html = html.replace(/\[(.+?)\]\((https?:\/\/[^\s]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
    
    // Line breaks
    html = html.replace(/\n/g,'<br>');
    
    return html;
  }

  function addMsg(role, content, attachments){
    // X√≥a empty state khi c√≥ tin nh·∫Øn ƒë·∫ßu ti√™n
    const emptyState = scroller.querySelector('.empty-state');
    if(emptyState && scroller.children.length === 1) {
      emptyState.remove();
    }
    
    const row = document.createElement('div');
    row.className='row '+role;
    const b=document.createElement('div');
    b.className='bubble '+role;
    
    if(role==='assistant') {
      b.innerHTML = md(content);
    } else {
      if (content && content !== '[G·ª≠i t·ªáp]') {
        const textNode = document.createElement('div');
        textNode.textContent = content;
        b.appendChild(textNode);
      }
      
      if(attachments && attachments.length){
        const wrap=document.createElement('div');
        wrap.style.marginTop='6px';
        attachments.forEach(a=>{
          if(a.type.startsWith('image/')){
            const img = document.createElement('img');
            img.src = `${a.type};base64,${a.b64}`;
            img.className = 'image-attachment';
            img.alt = a.name;
            wrap.appendChild(img);
          } else {
            const pill=document.createElement('span');
            pill.className='file-pill';
            pill.textContent='üìé '+a.name;
            wrap.appendChild(pill);
          }
        });
        b.appendChild(wrap);
      }
    }
    
    row.appendChild(b);
    scroller.appendChild(row);
    scrollToBottom();
    return b;
  }

  function renderMath(node){
    try{
      if(window.renderMathInElement){
        renderMathInElement(node,{delimiters:[{left:',right:',display:true},{left:'$',right:'$',display:false},{left:'\\(',right:'\\)',display:false},{left:'\\[',right:'\\]',display:true}]});
      }
    }catch(e){}
  }

  function showThinking(){
    think.style.display='block';
    dots.innerHTML='';
    setTimeout(() => {
      think.classList.add('show');
    }, 10);
  }
  
  function hideThinking(){
    think.classList.remove('show');
    think.classList.add('fade-out');
    setTimeout(() => {
      think.style.display='none';
      think.classList.remove('fade-out');
    }, 300);
  }
  
  function setMilestones(list){
    dots.innerHTML='';
    list.forEach(m=>{
      const d=document.createElement('div');
      d.className='dot '+(m.status||'');
      d.innerHTML=`<i></i><span>${m.text}</span>`;
      dots.appendChild(d);
    });
  }
  
  btnToggleThink.onclick = ()=>{
    const body=$('#thinkBody');
    body.style.display = body.style.display==='none'?'':'none';
    btnToggleThink.textContent = body.style.display==='none' ? 'M·ªü r·ªông' : 'Thu g·ªçn';
  };

  let pending = [];
  const file = $('#file');
  $('#btnAttach').onclick = ()=> file.click();
  
  file.onchange = async (e)=>{
    const f=e.target.files[0];
    if(!f) return;
    if(f.size>8*1024*1024) return alert('T·ªëi ƒëa 8MB');
    const b64=await toB64(f);
    pending.push({name:f.name,type:f.type,size:f.size,b64});
    renderAttach();
    file.value='';
  };
  
  document.addEventListener('paste', async (e)=>{
    const it=[...(e.clipboardData?.items||[])].find(i=>i.type.startsWith('image/'));
    if(it){
      const f=it.getAsFile();
      const b64=await toB64(f);
      pending.push({name:f.name||'pasted.png', type:f.type, size:f.size, b64});
      renderAttach();
    }
  });
  
  function renderAttach(){
    const wrap=$('#attachList');
    wrap.innerHTML='';
    pending.forEach((a,i)=>{
      const s=document.createElement('span');
      s.className='file-pill';
      if(a.type.startsWith('image/')){
        const img = document.createElement('img');
        img.src = `${a.type};base64,${a.b64}`;
        img.style.width = '20px';
        img.style.height = '20px';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '4px';
        img.style.marginRight = '4px';
        s.innerHTML = '';
        s.appendChild(img);
        s.appendChild(document.createTextNode(a.name));
      } else {
        s.innerHTML=`üìé ${a.name}`;
      }
      s.innerHTML += ` <button data-i="${i}" style="border:none;background:transparent;font-size:14px">‚úñ</button>`;
      s.querySelector('button').onclick=(ev)=>{
        const k=Number(ev.target.dataset.i);
        pending.splice(k,1);
        renderAttach();
      };
      wrap.appendChild(s);
    });
  }
  
  function toB64(file){
    return new Promise((res,rej)=>{
      const r=new FileReader();
      r.onload=()=>res(r.result.split(',')[1]);
      r.onerror=rej;
      r.readAsDataURL(file);
    });
  }

  function apiUrl(){
    // S·ª≠ d·ª•ng proxy Vercel
    // Thay YOUR_VERCEL_PROXY_URL b·∫±ng URL th·ª±c t·∫ø c·ªßa b·∫°n tr√™n Vercel
    const vercelProxyUrl = 'https://your-vercel-proxy-url.vercel.app/api/proxy'; // <--- C·∫¨P NH·∫¨T URL N√ÄY
    // N·∫øu b·∫°n kh√¥ng c√≥ proxy Vercel, b·∫°n c√≥ th·ªÉ th·ª≠ c√°c proxy kh√°c, nh∆∞ng kh√¥ng ·ªïn ƒë·ªãnh
    // const corsProxyUrl = 'https://corsproxy.io/?' + encodeURIComponent('https://api.anthropic.com/v1/messages');
    // return corsProxyUrl;
    return vercelProxyUrl; // S·ª≠ d·ª•ng proxy Vercel
  }
  
  let controller=null;
  
  async function* claudeStream({apiKey, model, msgs, temperature, max_tokens}){
    // Ki·ªÉm tra API key tr∆∞·ªõc (kh√¥ng c√≤n c·∫ßn thi·∫øt n·∫øu proxy t·ª± cung c·∫•p)
    // if(!apiKey || !apiKey.startsWith('sk-ant-')) {
    //   throw new Error('API Key kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i API Key trong C√†i ƒë·∫∑t.');
    // }
    
    // Headers v√† body ƒë∆∞·ª£c g·ª≠i ƒë·∫øn proxy Vercel
    const headers={
      'Content-Type':'application/json',
      // API Key ƒë∆∞·ª£c proxy x·ª≠ l√Ω, kh√¥ng g·ª≠i tr·ª±c ti·∫øp t·ª´ client
      // 'x-api-key':apiKey, 
      'anthropic-version':'2023-06-01'
    };
    const body={
      model,
      temperature,
      max_tokens,
      stream:true,
      messages: msgs.map(m=>{
        if(m.role==='user'&&m.attachments?.length){
          const content=[{type:'text',text:m.content}];
          m.attachments.forEach(a=>{
            if(a.type.startsWith('image/')) content.push({type:'image', source:{type:'base64', media_type:a.type, data:a.b64}});
            else content.push({type:'text',text:`[T·ªáp: ${a.name}]`});
          });
          return {role:'user',content};
        }
        return {role:m.role, content:m.content};
      })
    };
    
    if(CFG.system) body.system=CFG.system;

    // G·ª≠i API Key v√† c√°c th√¥ng tin nh·∫°y c·∫£m kh√°c d∆∞·ªõi d·∫°ng header t√πy ch·ªânh ƒë·∫øn proxy
    headers['x-anthropic-api-key'] = apiKey; // Proxy s·∫Ω nh·∫≠n header n√†y
    
    controller = new AbortController();
    
    let resp;
    try {
      resp = await fetch(apiUrl(),{
        method:'POST',
        headers,
        body:JSON.stringify(body),
        signal:controller.signal,
        mode: 'cors'
      });
    } catch(fetchError) {
      throw new Error(`L·ªói k·∫øt n·ªëi: ${fetchError.message}. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† URL proxy.`);
    }
    
    if(!resp.ok){
      const errorText = await resp.text();
      if(resp.status === 401) {
        throw new Error('L·ªói 401: X√°c th·ª±c th·∫•t b·∫°i (t·ª´ proxy). Vui l√≤ng ki·ªÉm tra API Key v√† proxy.');
      } else if(resp.status === 403) {
        throw new Error('L·ªói 403: Truy c·∫≠p b·ªã t·ª´ ch·ªëi (t·ª´ proxy). Vui l√≤ng ki·ªÉm tra quy·ªÅn h·∫°n v√† proxy.');
      } else if(resp.status === 429) {
        throw new Error('L·ªói 429: Qu√° nhi·ªÅu y√™u c·∫ßu (t·ª´ proxy). Vui l√≤ng ƒë·ª£i m·ªôt l√∫c.');
      } else {
        throw new Error(`L·ªói t·ª´ proxy ${resp.status}: ${errorText || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`);
      }
    }
    
    const reader=resp.body.getReader();
    const decoder=new TextDecoder();
    let buf='';
    
    setMilestones([
      {text:'K·∫øt n·ªëi API',status:'done'},
      {text:'Ph√¢n t√≠ch y√™u c·∫ßu',status:'active'},
      {text:'Sinh n·ªôi dung',status:''}
    ]);
    showThinking();
    
    while(true){
      const {done,value}=await reader.read();
      if(done) break;
      
      buf+=decoder.decode(value,{stream:true});
      const lines=buf.split('\n');
      buf=lines.pop()||'';
      
      for(const line of lines){
        if(!line.trim() || !line.startsWith('')) continue;
        const data=line.slice(5).trim();
        if(data==='[DONE]') continue;
        
        try{
          const evt=JSON.parse(data);
          
          if(evt.type==='content_block_start'){
            setMilestones([
              {text:'K·∫øt n·ªëi API',status:'done'},
              {text:'Ph√¢n t√≠ch y√™u c·∫ßu',status:'done'},
              {text:'Sinh n·ªôi dung',status:'active'}
            ]);
          }
          
          if(evt.type==='content_block_delta' && evt.delta?.text){
            yield {type:'delta', text:evt.delta.text};
          }
          
          if(evt.type==='message_stop'){
            setMilestones([
              {text:'K·∫øt n·ªëi API',status:'done'},
              {text:'Ph√¢n t√≠ch y√™u c·∫ßu',status:'done'},
              {text:'Sinh n·ªôi dung',status:'done'}
            ]);
            yield {type:'done'};
          }
        }catch(e){
          console.error('Parse error:', e);
        }
      }
    }
  }

  function msgsForAPI(){
    return (CURRENT?.msgs||[]).map(m=>({role:m.role,content:m.content,attachments:m.attachments}));
  }

  $('#form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(isGenerating) return;
    
    const prompt = text.value.trim();
    if(!prompt && pending.length===0) return;
    
    const userMsg={role:'user',content: prompt||'[G·ª≠i t·ªáp]', attachments: pending.slice()};
    pending.length=0;
    renderAttach();
    
    if(!CURRENT) newChat(userMsg);
    else {
      CURRENT.msgs.push(userMsg);
      saveCurrent();
    }
    
    addMsg('user', userMsg.content, userMsg.attachments);
    text.value='';
    autoGrow();
    
    await generate();
  });

  async function generate(){
    // Kh√¥ng c·∫ßn ki·ªÉm tra CFG.key n·ªØa n·∫øu proxy x·ª≠ l√Ω
    // if(!CFG.key) return alert('H√£y nh·∫≠p API Key trong C√†i ƒë·∫∑t.');
    if(!CFG.key) return addMsg('assistant', '‚ùå API Key ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh trong m√£ ngu·ªìn.'); // Th√¥ng b√°o n·∫øu c·∫ßn

    isGenerating = true;
    userScrolled = false;
    sendBtn.disabled=true;
    sendBtn.textContent='‚Ä¶';
    
    const bubble = document.createElement('div');
    bubble.className='bubble assistant';
    bubble.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
    const row = document.createElement('div');
    row.className='row assistant';
    row.appendChild(bubble);
    scroller.appendChild(row);
    scrollToBottom();
    
    let reply='';
    
    try{
      for await (const ev of claudeStream({
        apiKey:CFG.key, // G·ª≠i key ƒë·∫øn proxy
        model:CFG.model,
        msgs:msgsForAPI(),
        temperature:CFG.temp,
        max_tokens:CFG.max_tokens
      })){
        if(ev.type==='delta' && ev.text){
          reply+=ev.text;
          bubble.innerHTML = md(reply);
          scrollToBottom();
        }
        if(ev.type==='done'){
          bubble.innerHTML = md(reply||'Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi.');
          hideThinking();
          renderMath(bubble);
          CURRENT.msgs.push({role:'assistant',content:reply});
          saveCurrent();
        }
      }
    }catch(err){
      bubble.innerHTML = '‚ùå L·ªói: '+(err.message||err);
      hideThinking();
    }
    finally{
      isGenerating = false;
      userScrolled = false;
      sendBtn.disabled=false;
      sendBtn.textContent='G·ª≠i';
      controller=null;
    }
  }

  function autoGrow(){
    text.style.height='auto';
    text.style.height=Math.min(text.scrollHeight,140)+'px';
  }
  
  text.addEventListener('input', autoGrow);
  text.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !e.shiftKey){
      e.preventDefault();
      $('#form').dispatchEvent(new Event('submit'));
    }
  });

  $('#btnSpeak').onclick = ()=>{
    const arr=(CURRENT?.msgs||[]).filter(m=>m.role==='assistant');
    const t=arr.length?arr[arr.length-1].content:'';
    if(!t) return alert('Ch∆∞a c√≥ n·ªôi dung');
    if(!('speechSynthesis' in window)) return alert('Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£');
    const u=new SpeechSynthesisUtterance(t.replace(/`[^`]*`/g,''));
    u.lang='vi-VN';
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  };

  let rec=null;
  $('#btnMic').onclick = ()=>{
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR) return alert('Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£');
    if(!rec){
      rec=new SR();
      rec.lang='vi-VN';
      rec.interimResults=false;
      rec.maxAlternatives=1;
      rec.onresult=(ev)=>{
        const t=ev.results[0][0].transcript;
        text.value=(text.value?text.value+' ':'')+t;
        autoGrow();
      };
    }
    rec.start();
  };

  scroller.addEventListener('click', (e)=>{
    const btn=e.target.closest('.copy-btn');
    if(btn){
      const raw=decodeURIComponent(btn.dataset.copy||'');
      navigator.clipboard.writeText(raw).then(()=>{
        btn.textContent='Copied ‚úì';
        setTimeout(()=>btn.textContent='Copy',900);
      });
    }
  });

  $('#btnNewChat').onclick = ()=> newChat();

  (function init(){
    modelChip.textContent = getModelName(CFG.model);
    const list=store.list();
    if(list[0]) loadChat(list[0].id);
    else newChat();
  })();
})();
</script>
</body>
</html>
